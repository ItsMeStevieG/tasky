{% extends 'base.twig' %}

{% block title %}Dashboard - Tasky{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">Weekly Summary</div>
    <div class="card-body">
        <p>Total Hours This Week: {{ weekly_hours|number_format(2) }}</p>
    </div>
</div>
<div class="card mb-4">
    <div class="card-header">Quick Timer</div>
    <div class="card-body">
        <form method="POST" action="index.php?nav=dashboard" id="timerForm">
            <input type="hidden" name="csrf_token" value="{{ auth.getCsrfToken() }}">
            <input type="hidden" name="action" value="add_entry">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <select name="project_id" class="form-select" required>
                        <option value="">Select Project</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <select name="tag_id" class="form-select">
                        <option value="">Select Tag</option>
                        {% for tag in tags %}
                        <option value="{{ tag.id }}">{{ tag.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <input type="text" id="timerDisplay" class="form-control" value="00:00:00" readonly>
                </div>
                <div class="col-md-4 mb-3">
                    <button type="button" id="startTimer" class="btn btn-success" data-bs-toggle="tooltip" title="Start tracking time">Start</button>
                    <button type="button" id="stopTimer" class="btn btn-danger" disabled data-bs-toggle="tooltip" title="Stop tracking time">Stop</button>
                    <button type="submit" id="saveTimer" class="btn btn-primary" disabled data-bs-toggle="tooltip" title="Save the time entry">Save</button>
                </div>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description"></textarea>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="is_billable" name="is_billable">
                <label class="form-check-label" for="is_billable">Billable</label>
            </div>
            <input type="hidden" name="start_time" id="startTime">
            <input type="hidden" name="end_time" id="endTime">
            <input type="hidden" name="date" value="{{ 'now'|date('Y-m-d') }}">
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Recent Entries</div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Project</th>
                    <th>Tag</th>
                    <th>Time</th>
                    <th>Hours</th>
                    <th>Description</th>
                    <th>Billable</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td>{{ entry.date }}</td>
                    <td>{{ entry.project_name|default('None') }}</td>
                    <td>{{ entry.tag_name|default('None') }}</td>
                    <td>{{ entry.start_time }} - {{ entry.end_time }}</td>
                    <td>{{ entry.hours_worked }}</td>
                    <td>{{ entry.description|default('') }}</td>
                    <td>{{ entry.is_billable ? 'Yes' : 'No' }}</td>
                    <td>
                        <a href="index.php?nav=edit_entry&id={{ entry.id }}" class="btn btn-sm btn-warning">Edit</a>
                        <a href="index.php?nav=delete_entry&id={{ entry.id }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block footscripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let timer;
    let seconds = 0;
    const timerDisplay = document.getElementById('timerDisplay');
    const startBtn = document.getElementById('startTimer');
    const stopBtn = document.getElementById('stopTimer');
    const saveBtn = document.getElementById('saveTimer');

    function updateTimer() {
        seconds++;
        let hrs = Math.floor(seconds / 3600);
        let mins = Math.floor((seconds % 3600) / 60);
        let secs = seconds % 60;
        timerDisplay.value = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    startBtn.addEventListener('click', () => {
        const now = new Date();
        document.getElementById('startTime').value = now.toTimeString().slice(0, 8);
        timer = setInterval(updateTimer, 1000);
        startBtn.disabled = true;
        stopBtn.disabled = false;
        saveBtn.disabled = false;
    });

    stopBtn.addEventListener('click', () => {
        clearInterval(timer);
        const now = new Date();
        document.getElementById('endTime').value = now.toTimeString().slice(0, 8);
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });

    // Enable Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
{% endblock %}